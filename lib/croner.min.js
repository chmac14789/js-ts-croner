// Licenced under MIT - croner 1.1.20 - Â©2016 Hexagon <github.com/hexagon>
(function(){"use strict";function t(t){throw new TypeError("Cron parser: "+t)}function e(t,e){for(var s=0;s<t.length;s++)t[s]=e;return t}function s(t){this.milliseconds=t.getMilliseconds(),this.seconds=t.getSeconds()+1,this.minutes=t.getMinutes(),this.hours=t.getHours(),this.days=t.getDate(),this.months=t.getMonth(),this.years=t.getFullYear()}function r(t){this.pattern=t,this.seconds=e(Array(60),0),this.minutes=e(Array(60),0),this.hours=e(Array(24),0),this.days=e(Array(31),0),this.months=e(Array(12),0),this.daysOfWeek=e(Array(8),0),this.parse()}function a(t,e,s){var n=this;return this instanceof a?(n.pattern=new r(t),n.schedulerDefaults={stopAt:1/0,maxRuns:1/0,kill:!1},"function"==typeof e&&(s=e,e={}),n.opts=n.validateOpts(e||{}),void 0===s?n:this.schedule(e,s)):new a(t,e,s)}var n=this,i=Math.pow(2,31)-1;s.prototype.increment=function(t){for(var e=this,s=function(t,s,r,a){for(var n=void 0===a?e[t]+r:0+r;n<s[t].length;n++)if(s[t][n])return e[t]=n-r,!0;return!1},r=[["seconds","minutes",0],["minutes","hours",0],["hours","days",0],["days","months",-1],["months","years",0]],a=0;a<5;){if(!s(r[a][0],t,r[a][2]))for(this[r[a][1]]++;a>=0;)s(r[a][0],t,r[a][2],0),a--;a++}for(;!t.daysOfWeek[this.getDate().getDay()];)this.days+=1},s.prototype.getDate=function(){return new Date(this.years,this.months,this.days,this.hours,this.minutes,this.seconds,500)},r.prototype.parse=function(){"string"!=typeof this.pattern&&this.pattern.constructor!==String&&t("Pattern has to be of type string.");var e,s,r,a,n,i=this.pattern.trim().replace(/\s+/g," ").split(" "),o=/[^\/\*0-9,-]+/;for(6!==i.length&&t("invalid configuration format ('"+this.pattern+"'), exacly five space separated parts required."),s=0;s<i.length;s++)e=i[s].trim(),o.test(e)&&t("configuration entry "+(s+1)+" ("+e+") contains illegal characters.");r="*"!==i[4],a="*"!==i[5],n="*"!==i[3],a&&(r||n)&&t("configuration invalid, you can not combine month/date with day of week."),this.partToArray("seconds",i[0],0),this.partToArray("minutes",i[1],0),this.partToArray("hours",i[2],0),this.partToArray("days",i[3],-1),this.partToArray("months",i[4],-1),this.partToArray("daysOfWeek",i[5],0),this.daysOfWeek[7]&&(this.daysOfWeek[0]=1)},r.prototype.partToArray=function(e,s,r){var a,n,i,o,u,p=this[e];if("*"!==s)if((n=s.split(",")).length>1)for(a=0;a<n.length;a++)this.partToArray(e,n[a],r);else if(-1!==s.indexOf("-"))for(2!==(n=s.split("-")).length&&t("Syntax error, illegal range: '"+s+"'"),i=parseInt(n[0],10)+r,o=parseInt(n[1],10)+r,isNaN(i)?t("Syntax error, illegal lower range (NaN)"):isNaN(o)&&t("Syntax error, illegal upper range (NaN)"),(i<0||o>=p.length)&&t("Value out of range: '"+s+"'"),i>o&&t("From value is larger than to value: '"+s+"'"),a=i;a<=o;a++)p[a+r]=1;else if(-1!==s.indexOf("/"))for(2!==(n=s.split("/")).length&&t("Syntax error, illegal stepping: '"+s+"'"),"*"!==n[0]&&t("Syntax error, left part of / needs to be * : '"+s+"'"),u=parseInt(n[1],10),isNaN(u)&&t("Syntax error, illegal stepping: (NaN)"),0===u&&t("Syntax error, illegal stepping: 0"),u>p.length&&t("Syntax error, steps cannot be greater than maximum value of part ("+p.length+")"),a=0;a<p.length;a+=u)p[a+r]=1;else((a=parseInt(s,10)+r)<0||a>=p.length)&&t(e+" value out of range: '"+s+"'"),p[a]=1;else for(a=0;a<p.length;a++)p[a]=1},a.prototype.next=function(t){var e=this._next(t);return e&&e.setMilliseconds(0),e},a.prototype._next=function(t){if(t=t||new Date,this.opts.startAt&&t<this.opts.startAt&&(t=this.opts.startAt),!(this.opts.maxRuns<=0||this.opts.kill)){var e,r=this.opts.stopAt||this.schedulerDefaults.stopAt,a=new s(t);return a.increment(this.pattern),e=a.getDate(),r&&e>=r?void 0:e}},a.prototype.validateOpts=function(e){return e.startAt&&(e.startAt.constructor!==Date?e.startAt=new Date(Date.parse(e.startAt)-1):e.startAt=new Date(e.startAt.getTime()-1),isNaN(e.startAt)&&t("Provided value for startAt could not be parsed as date.")),e.stopAt&&(e.stopAt.constructor!==Date&&(e.stopAt=new Date(Date.parse(e.stopAt))),isNaN(e.stopAt)&&t("Provided value for stopAt could not be parsed as date.")),e},a.prototype.msToNext=function(t){t=t||new Date;var e=this._next(t);return e?this._next(t)-t.getTime():e},a.prototype.schedule=function(t,e){var s,r=this,a=r.maxDelay||i;if(e||(e=t,t={}),t.paused=void 0!==t.paused&&t.paused,t.kill=t.kill||this.schedulerDefaults.kill,t.rest=t.rest||0,t.maxRuns||0===t.maxRuns||(t.maxRuns=this.schedulerDefaults.maxRuns),r.opts=r.validateOpts(t||{}),void 0!==(s=this.msToNext(t.previous)))return s>a&&(s=a),t.currentTimeout=setTimeout(function(){s===a||t.paused||(t.maxRuns--,t.previous=new Date,e()),t.paused&&(t.previous=new Date),r.schedule(t,e)},s),{stop:function(){t.kill=!0,t.currentTimeout&&clearTimeout(t.currentTimeout)},pause:function(){return(t.paused=!0)&&!t.kill},resume:function(){return!(t.paused=!1)&&!t.kill}}},"undefined"!=typeof module&&"object"==typeof module.exports?module.exports=a:"function"==typeof define&&define.amd?define([],function(){return a}):n.Cron=a}).call(this);