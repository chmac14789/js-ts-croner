// Licenced under MIT - croner - Â©2016 Hexagon <github.com/hexagon>
(function(){"use strict";function t(t){throw new TypeError("Cron parser: "+t)}function e(){return new Date((new Date).setMilliseconds(0))}function s(t,e){for(var s=0;s<t.length;s++)t[s]=e;return t}function r(t){this.seconds=t.getSeconds()+1,this.minutes=t.getMinutes(),this.hours=t.getHours(),this.days=t.getDate(),this.months=t.getMonth(),this.years=t.getFullYear()}function i(t){this.pattern=t,this.seconds=s(Array(60),0),this.minutes=s(Array(60),0),this.hours=s(Array(24),0),this.days=s(Array(31),0),this.months=s(Array(12),0),this.daysOfWeek=s(Array(8),0),this.parse()}function n(t){var e=this;return this instanceof n?(e.pattern=new i(t),e.schedulerDefaults={stopAt:1/0,maxRuns:1/0,kill:!1},this):new n(t)}var a=this,o=Math.pow(2,31)-1;r.prototype.findNext=function(t,e,s,r){for(var i=void 0===r?this[t]+s:0+s,n=!1,a=i;a<e[t].length;a++)if(e[t][a]){this[t]=a-s,n=!0;break}return n},r.prototype.increment=function(t){for(var e=[["seconds","minutes",0],["minutes","hours",0],["hours","days",0],["days","months",-1],["months","years",0]],s=0;5>s;){if(!this.findNext(e[s][0],t,e[s][2]))for(this[e[s][1]]++;s>=0;)this.findNext(e[s][0],t,e[s][2],0),s--;s++}for(;!t.daysOfWeek[this.getDate().getDay()];)this.days+=1},r.prototype.getDate=function(){return new Date(this.years,this.months,this.days,this.hours,this.minutes,this.seconds,0)},i.prototype.parse=function(){"string"!=typeof this.pattern&&t("invalid configuration string ('"+this.pattern+"').");var e,s,r,i,n,a=this.pattern.trim().replace(/\s+/g," ").split(" "),o=/[^0-9,-]+/;for(6!==a.length&&t("invalid configuration format ('"+this.pattern+"'), exacly five space separated parts required."),s=0;s<a.length;s++)e=a[s].trim(),"*"!==e&&o.test(e)&&t("configuration entry "+(s+1)+" ("+e+") contains illegal characters.");r="*"!==a[4],i="*"!==a[5],n="*"!==a[3],i&&(r||n)&&t("configuration invalid, you can not combine month/date with day of week."),this.partToArray("seconds",this.seconds,a[0],0),this.partToArray("minutes",this.minutes,a[1],0),this.partToArray("hours",this.hours,a[2],0),this.partToArray("days",this.days,a[3],-1),this.partToArray("months",this.months,a[4],-1),this.partToArray("daysOfWeek",this.daysOfWeek,a[5],0),this.daysOfWeek[0]&&(this.daysOfWeek[7]=1),this.daysOfWeek[7]&&(this.daysOfWeek[0]=1)},i.prototype.partToArray=function(e,s,r,i){var n,a,o,u,h,l,p;if("*"!==r)if(o=r.split(","),o.length>1)for(n=0;n<o.length;n++)this.partToArray(e,s,o[n],i);else if(-1===r.indexOf("-"))h=parseInt(r,10)+i,(0>h||h>=s.length)&&t(e+" value out of range: '"+r+"'"),s[h]=1;else for(u=r.split("-"),2!==u.length&&t("syntax error, illegal range: '"+r+"'"),l=parseInt(u[0],10)+i,p=parseInt(u[1],10)+i,isNaN(l)?t("syntax error, illegal lower range (NaN)"):isNaN(p)&&t("syntax error, illegal upper range (NaN)"),(0>l||p>=s.length)&&t("value out of range: '"+r+"'"),l>p&&t("from value is larger than to value: '"+r+"'"),a=l;p>=a;a++)s[a+i]=1;else for(n=0;n<s.length;n++)s[n]=1},n.prototype.next=function(t){var s=new r(t||e());return s.increment(this.pattern),s.getDate()},n.prototype.msToNext=function(t){return t=t||e(),this.next(t)-t.getTime()},n.prototype.schedule=function(t,s,r){var i,n=this,a=n.maxDelay||o;return s||(s=t,t={}),t.paused="undefined"==typeof t.paused?!1:t.paused,t.previous=r===!1?e():t.startAt||t.previous,t.stopAt=t.stopAt||this.schedulerDefaults.stopAt,t.kill=t.kill||this.schedulerDefaults.kill,t.rest=t.rest||0,t.maxRuns||0===t.maxRuns||(t.maxRuns=this.schedulerDefaults.maxRuns),t.startAt=void 0,i=this.msToNext(t.previous),t.maxRuns<=0||t.stopAt!==1/0&&t.previous.getTime()+i/1e3>t.stopAt.getTime()||t.kill?void 0:(i>a&&(i=a),t.currentTimeout=setTimeout(function(){i===a||t.paused||(t.maxRuns--,t.previous=e(),s()),t.paused&&(t.previous=e()),n.schedule(t,s,!0)},i),{stop:function(){t.kill=!0,t.currentTimeout&&clearTimeout(t.currentTimeout)},pause:function(){return(t.paused=!0)&&!t.kill},resume:function(){return!(t.paused=!1)&&!t.kill}})},"undefined"!=typeof module&&"object"==typeof module.exports?module.exports=n:"function"==typeof define&&define.amd?define([],function(){return n}):a.cron=n}).call(this);